<div th:fragment="content">
    <h2>Brand Management</h2>
    <hr>
    <div class="row mb-2">
       	<button id="createNewBtn">Create New</button>
        <div class="col-md-4">
            <form id="newBrandForm" style="display: none;">
            <table class="table table-bordered">
			    <tr>
			        <td><label for="name">Name</label></td>
			        <td><input type="text" id="name" name="name" placeholder="Enter brand name" ></td>
			    </tr>
			    <tr>
			        <td><label for="description">Description</label></td>
			        <td><input type="text" id="description" name="description" placeholder="Enter brand description" ></td>
			    </tr>
			    <tr>
			        <td><label for="imageFile">Image</label></td>
			        <td><input type="file" id="imageFile" name="imageFile" accept="image/*" ></td>
			    </tr>
			    <tr>
			        <td><label for="additionalDetails">Additional Details</label></td>
			        <td><input type="textarea" row="5" col="20" id="additionalDetails" name="additionalDetails" placeholder="Enter additional details" ></td>
			    </tr>
			    <tr>
			    	<td></td>
			    	<td>
			    		<button type="submit" class="btn btn-success">Save</button>
			    	</td>
			    </tr>
			    </table>
			</form>
        </div>
    </div>
    <hr>
    <div class="table-responsive">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Image</th>
                    <th>Description</th>
                    <th>Additional Details</th>
                </tr>
            </thead>
            <tbody id="brandTableBody">
                <!-- Data will be dynamically populated here -->
            </tbody>
        </table>
    </div>
    <!-- Page navigation -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center" id="paginationNav">
            <!-- Pagination buttons will be dynamically added here -->
        </ul>
    </nav>
    
    <script>
    $(document).ready(function() {
    	function loadData(page) {
            $.ajax({
                url: "/brand/all?cp=" + page,
                type: "GET",
                success: function(data) {
                    // Populate grid with data
                    console.log(data);
                    populateTable(data);
                    populatePagination(data);
                }
            });
        }
    	function populateTable(data) {
            var tableBody = $('#brandTableBody');
            tableBody.empty(); // Clear existing data

            $.each(data.content, function(index, brand) {
                var row = '<tr>' +
                              '<td>' + brand.id + '</td>' +
                              '<td class="editable" data-field="name" data-id="' + brand.id + '">' + brand.name + '<br><button class="edit-button" data-id="' + brand.id + '">Edit</button>&nbsp;<button class="delete-button" data-id="' + brand.id + '">Delete</button><br>Updated: ' + new Date(brand.updateTimestamp).toLocaleDateString() + ' <br>Created: ' + new Date(brand.createTimestamp).toLocaleDateString() + '</td>' +
                              '<td class="editable" data-field="imgUrl" data-id="' + brand.id + '"><img src="' + brand.imgUrl + '" width="100px" height="100px" onerror="/mall/noImage.jpg"/></td>' +
                              '<td class="editable" data-field="description" data-id="' + brand.id + '">' + brand.description + '</td>' +
                              '<td class="editable" data-field="additionalDetails" data-id="' + brand.id + '">' + brand.additionalDetails + '</td>' +
                          '</tr>';
                tableBody.append(row);
            });
        }
    	// Enable inline editing
    	$('#brandTableBody').on('click', '.edit-button', function() {
    		console.log('editable')
    	    var $this = $(this);
    	    var field = $this.data('field');
    	    var id = $this.data('id');
    	    console.log('editable: '+ id)
    	    var value = $this.text();
    	    var newValue = prompt('Edit ' + field, value);
    	    
    	    if (newValue !== null && newValue !== value) {
    	        // Perform AJAX request to update the value in the backend
    	        $.ajax({
    	            url: '/brand/update', // Change this to your update endpoint
    	            type: 'PUT',
    	            data: {
    	                id: id,
    	                field: field,
    	                value: newValue
    	            },
    	            success: function(response) {
    	                // Update the value in the table if update is successful
    	                $this.text(newValue);
    	            },
    	            error: function(xhr, status, error) {
    	                alert('Failed to update ' + field + ': ' + error);
    	            }
    	        });
    	    }
    	});

    	// Handle deletion
    	$('#brandTableBody').on('click', '.delete-button', function() {
    	    var id = $(this).data('id');
    	    var confirmDelete = confirm('Are you sure you want to delete this brand?');

    	    if (confirmDelete) {
    	        // Perform AJAX request to delete the brand from the backend
    	        $.ajax({
    	            url: '/brand/delete', // Change this to your delete endpoint
    	            type: 'DELETE',
    	            data: {
    	                id: id
    	            },
    	            success: function(response) {
    	                // Remove the row from the table if deletion is successful
    	                $('#brand_' + id).remove();
    	            },
    	            error: function(xhr, status, error) {
    	                alert('Failed to delete brand: ' + error);
    	            }
    	        });
    	    }
    	});
        // Function to populate pagination
        function populatePagination(data) {
            var paginationNav = $('#paginationNav');
            paginationNav.empty(); // Clear existing pagination

            if (!data.empty && data.pageable && data.totalElements > data.pageable.pageSize) {
                var pageable = data.pageable;
                var currentPage = pageable.pageNumber + 1;
                // Add "First" and "Previous" buttons
                var firstPageClass = pageable.first ? 'disabled' : '';
                var previousPageClass = pageable.first ? 'disabled' : '';
                paginationNav.append('<li class="page-item ' + firstPageClass + '"><a class="page-link" data-page="1">First</a></li>');
                paginationNav.append('<li class="page-item ' + previousPageClass + '"><a class="page-link" data-page="' + (currentPage - 1) + '">Previous</a></li>');

                // Add numbered page buttons
                for (var i = 1; i <= pageable.totalPages; i++) {
                    var activeClass = (i === currentPage) ? 'active' : '';
                    paginationNav.append('<li class="page-item ' + activeClass + '"><a class="page-link" data-page="' + i + '">' + i + '</a></li>');
                }

                // Add "Next" and "Last" buttons
                var nextPageClass = pageable.last ? 'disabled' : '';
                var lastPageClass = pageable.last ? 'disabled' : '';
                paginationNav.append('<li class="page-item ' + nextPageClass + '"><a class="page-link" data-page="' + (currentPage + 1) + '">Next</a></li>');
                paginationNav.append('<li class="page-item ' + lastPageClass + '"><a class="page-link" data-page="' + pageable.totalPages + '">Last</a></li>');
            }
        }
    	loadData(0);
    	$(document).on("click", ".page-link", function(){
            var page = $(this).data("page");
            loadData(page);
            return false;
        });
    	$('#createNewBtn').click(function(){
            $('#newBrandForm').toggle();
        });

        $('#newBrandForm').submit(function(event){
            event.preventDefault(); // Prevent the form from submitting normally

            var formData = new FormData($(this)[0]);

            $.ajax({
                url: '/brand/save',
                type: 'POST',
                data: formData,
                async: false,
                cache: false,
                contentType: false,
                processData: false,
                success: function(response) {
                    // Handle success response
                    console.log(response);
                    // empty form on success
                    $('#newBrandForm')[0].reset();
                    // If needed, refresh the table to display the new data
                    loadData(0);
                },
                error: function(xhr, status, error) {
                    // Handle error response
                    console.error(xhr.responseText);
                }
            });
            return false;
        });
    });
    </script>
</div>